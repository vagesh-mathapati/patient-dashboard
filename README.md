# Patient Dashboard
Patient Dashboard is K8S based microservice application which is used to analyze patients data and provide insights to the user.
This is multi-tenanted application where each tenant (referred as hospital) can have multiple patients. Each user based on role 
can view the details of patients and view the insights generated by the application.

## Setup Instruction

### Pre-requisite
1. JDK 17
2. PostgreSQL
3. Postman or Curl to run APIs

### Steps to run
1. Download the code https://github.com/vagesh-mathapati/patient-dashboard.git on your machine
2. cd app
3. mvn clean install
4. java -jar target/patient-dashboard-0.0.1-SNAPSHOT.jar
5. Invoke API from Postman. 
6. Swagger URL will be available at http://localhost:8080/swagger-ui/index.html


## Design Decision

### Current available Features
- Multi-tenanted application
- Return Patient data based on filters
- Cohorts management
- Return patient details from saved Cohorts
- All data can be accessed through APIs

### Current Design
1. Stateless Javabased application
2. Backend PostgreSQL
3. 3 tables
	* patients --> This table will store basic details of patients like first name,last name, age, gender
	* doctors --> This table will store basic details of doctors like first name, last name, department
	* visits --> Considering Patient will visit multiple time to hospital and to multiple doctors so there will be separate table which will hold patient_id (FK of patients), doctor_id (FK of doctors), visit_date,diagnosis, prescription, notes
4. As per req we wanted to fetch data from millions of records so created View patient_visit_summary which will do LEFT JOIN like	--> patients LEFT JOIN visits LEFT JOIN doctors
	* Considering view is virtual table created from query and doesn't store the data actually so No Storage cost, No maintenance cost, No Manual updates whenever data updated in actual table.
	* Cons may be bit slower compare to other approaches like Materialized View, ElasticSearch, Redis Cache
	* Added indexes on tables to get result faster but this may slows down some of patient and visits CRUD queries
5. Extensible APIs. As per requirement new set of APIs can be added or modify existing APIs. Versioning can be used to modify request and responses in Future
6. Springboot based application which will help to adopt openAPI yaml easily, less boilerplate code, Cloud based capabilities like reading ConfigMap, secret and auto refresh, readiness liveliness probe, etc..
7. Use of JPA and Hibernate will help to write SQL Server agnostic queries and code
8. Liquibase to manage schema
9. Currently APIs are multitenant using hospitalId.. This can be changed to anything like stateId, etc... 
10. Also data can be persisted using Schema per tenant so that no of records of Visits will be limited to that hospital or area... This will help to execute queries faster

 ![Current Design](https://github.com/vagesh-mathapati/patient-dashboard/blob/main/CurrentDesign.jpg)

### Mid term and Long term Solutions
1. Try with Materialized View and perform result comparison with normal View. 
2. Also measure the impact on patients, visits  CRUD queries performance.
3. Generally Relational DB can not scale horizontally so other design can be considered of streaming data to ElasticSearch. Instead of querying to DB query to ElasticSearch.
4. There will be challenges of guaranteed data delivery in Elastic Search for that Kafka can be used to sink and stream data to ElasticSearch. 
5. Important point of Additional maintenance of ElasticSearch instances and cost need to be evaluated based on overall load and Return on Investments
6. Frequently called queries or responses can be cached in Redis Cache to reduce more load on DB. 
7. Integrate with A&A system so that SSO can be implemented
8. Provide support of RBAC. Based on Role provide access to apply filter, run existing saved cohorts, 
9. Based on roles control which kind of data cane be returned.
10. Audit on Cohorts CRUD and who executed reports
11. HIPAA/GDPR compliance
	* Encrypt sensitive data at transit and at rest
	* RBAC and based on persona return only required data
	* Pseudonymization - Replace PHI (Protected Health Information) like names & SSNs with unique IDs.
	* With SSO can support MFA
	* Audit who accessed what data
	* Make sure as per compliance data is logged
12. Add all required yamls for gettign deployed on K8S. Configure Github workflow
	 ![Future Design](https://github.com/vagesh-mathapati/patient-dashboard/blob/main/FutureDesign.jpg)


### Working APIs
1. Paginated API to get patient details based on filter.

POST http://localhost:8080/v1/hospitals/1d831e1b-4d9f-4446-85d9-e05b2652557b/patients-details?pageSize=9000
RequestBody 
	{
  "age": {
    "operator": ">",
    "value": 30
  },
  "diagnosis": {
    "operator": "CONTAINS",
    "value": "Depression"
  } ,
  "lastVisitAfter": {
    "operator": "AFTER",
    "value": "2021-01-01"
  }
}

Response 200 OK with paginated data... Links can be used to get next or previous page details

2. Create Cohort

POST http://localhost:8080/v1/hospitals/1d831e1b-4d9f-4446-85d9-e05b2652557b/cohorts
{
  "name": "Diabetic Patients 50+",
  "filters": {
    "age": {
      "operator": ">",
      "value": 50
    },
    "diagnosis": {
      "operator": "CONTAINS",
      "value": "diabetes"
    },
    "lastVisitAfter": {
      "operator": "AFTER",
      "value": "2021-01-01"
    }
  }
}

Response 201 Created

3. Get Individual Cohort

GET http://localhost:8080/v1/hospitals/1d831e1b-4d9f-4446-85d9-e05b2652557b/cohorts/da2a0a77-a6e3-4a60-836d-270f061a8f1f

Response 200 OK with Cohort details

4. Execute saved Cohort 

POST http://localhost:8080/v1/hospitals/1d831e1b-4d9f-4446-85d9-e05b2652557b/cohorts/fb97eedc-4442-4a8c-8898-0dc987dc65c2:execute?pageSize=500 

Response 200 OK with paginated data... Links can be used to get next or previous page details

5. Get all saved Cohorts
GET http://localhost:8080/v1/hospitals/1d831e1b-4d9f-4446-85d9-e05b2652557b/cohorts

### Performance results

#### Test Data
1. Seed 4000 Patients data into DB.
2. Seed 50 Doctors data into DB.
3. Seed 40000 visits data into DB.
4. Single app running.

#### Test results
1. To get "Diabetic Patients 50+ Age " taking around ~70 ms
2. To get "Depression patients 30+ Age" taking around ~80 ms
3. To get all patients with visits details taking around ~70ms

### Mock Screens
1. Generally Analytics or reports are tabular for that Power BI or Python etc.. can be used.
2. For now below are mock screens to Create Cohorts with filter. 
	* After done either Genrate report 
	* Save Cohort
	![Cohort Config](https://github.com/vagesh-mathapati/patient-dashboard/blob/main/CohortCreateMockScreen.jpg)
3. Following screen will show paginated Reports data
 ![Reports](https://github.com/vagesh-mathapati/patient-dashboard/blob/main/ReportMockScreen.jpg)
